
# The docker image file for the jenkins slave nodes.
# 
# This is a debian based container that includes the tools that are required to execute a CPF build-pipeline.

FROM ubuntu:20.04

# Prevents the need of user interaction with "Configuring tzdata"
ENV DEBIAN_FRONTEND=noninteractive 


# ----------------------- ADD USER JENKINS -------------------------------
# Set user jenkins to the image 
RUN useradd -m -d /home/jenkins -s /bin/sh jenkins &&\
    echo "jenkins:jenkins" | chpasswd

    
# ----------------------- INSTALL BASIC TOOLS -------------------------------
# install basic tools
# - wget to download packages
# - openssh-server needed to allow the build master to access the slave
# - vim for manual editing files
# - netcat can be used to manuall examine the network when debugging the container
# - tree is used when running the pipeline for debug purposes
# - git for downloading the code-base
# - python is used to implement the build-pipeline.
# - sudo is required by some conan packages.
# - libgl1-mesa-dev is a dependency of the conan qt package. If this is not installed, conan will try to apt-get install it itself
#   which blocks the conan execution due to the sudo password request.
# - pkg-config If this is missing we get errors in the conan qt clang build.
#
RUN apt-get -q update && apt-get -q -y install \
build-essential \
llvm-10 \
clang \
clang-10 \
clang-format-10 \
clang-tidy-10 \
ninja-build \
cmake \
python3 \
python3-pip \
wget \
openssh-server \
vim \
netcat \
tree \
unzip \
git \
xvfb \
graphviz \
valgrind \
abi-compliance-checker \
universal-ctags \
abi-dumper \
openjdk-8-jdk \
libgl1-mesa-dev \
pkg-config \
doxygen


# ----------------- INSTALL PYTHON Modules --------------
# This should be done in the cmake code of the package-project
RUN python3 -m pip install \
paramiko \
requests \
sphinx \
conan

# ----------------- Downgrade Python to 3.6 --------------
# The unittest module of python 3.8 caused the CPFTests to fail.
# We use python 3.6 until this gets fixed.
COPY buildPython.sh buildPython.sh
RUN /bin/bash buildPython.sh

# ----------------- Configure Git --------------
USER jenkins
RUN git config --global user.email "not@valid.com" &&\
    git config --global user.name "jenkins" &&\
    git config --global credential.helper 'store --file ~/.jenkins-git-credentials'


# ----------------- Configure Conan --------------
# Add the additional bincrafters package repository 
RUN conan remote add bincrafters https://api.bintray.com/conan/bincrafters/public-conan



USER root
    
# --------------- PREPARE SSH DEAMON ---------------     
# prepare running sshd
RUN sed -i 's|session required pam_loginuid.so|session optional pam_loginuid.so|g' /etc/pam.d/sshd &&\
    mkdir -p /var/run/sshd
    
COPY ssh_config /etc/ssh/sshd_config

# -------------- Create some directories and copy some files -----------
RUN mkdir /home/jenkins/.ssh &&\
mkdir /home/jenkins/bin &&\
mkdir -p /home/jenkins/.ssh &&\
chown -R jenkins:jenkins /home/jenkins/.ssh

 # This file is run by the jenkins-master to start the slave
COPY agent.jar /home/jenkins/bin/agent.jar         
RUN chown -R jenkins:jenkins /home/jenkins/bin
 
  
# ----------------- JAVA ----------------------
# Install JDK 8 (latest edition) 
#RUN echo "deb http://debian.netcologne.de/debian jessie-backports main" | tee --append /etc/apt/sources.list &&\
#      apt-get update &&\
#      apt-get install -y -t jessie-backports openjdk-8-jdk

#RUN apt-get update &&\
#    apt-get install -y openjdk-8-jdk



# Run the sshd server as command to keep the container alive.
CMD ["/usr/sbin/sshd", "-D"]
