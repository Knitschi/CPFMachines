# This is a docker image for a container that runs the apache2 webserver 
# to publish the doxygen generated documentation with server-side searching.
# To implement server-side searching the web-server needs the doxysearch.cgi
# from the doxygen application.

# The container needs a serach database and the html content of the displayed page.
# The information is provided by external sources over the shared mounted volume /var/www/html
# Refer to the CMakeProjectFramework documentation on how to start the container.

FROM debian:9.3

# INSTALL PACKAGES
RUN apt-get -y update && apt-get install -y \
openssh-server \
apache2 \
supervisor \
netcat \
vim \
tree \
git

# --------------- SETUP JENKINS USER ---------------
ARG user=jenkins
ARG group=jenkins
ARG uid=1000
ARG gid=1000
ARG JENKINS_HOME=/home/${user}
# Jenkins is run with user `jenkins`, uid = 1000
# If you bind mount a volume from the host or a data container,
# ensure you use the same uid
RUN mkdir -p $JENKINS_HOME \
  && chown ${uid}:${gid} $JENKINS_HOME \
  && groupadd -g ${gid} ${group} \
  && useradd -d "$JENKINS_HOME" -u ${uid} -g ${gid} -m -s /bin/bash ${user}


# --------------- SETUP WEB CONTENT REPOSITORY --------------- 
RUN mkdir $JENKINS_HOME/WebContentRepository \
    && git init --bare $JENKINS_HOME/WebContentRepository \
    && mkdir $JENKINS_HOME/WebContent

# The post-receive hook checks out the repo content into the WebContent directory after
# each commit.
COPY web-server-post-receive.in $JENKINS_HOME/WebContentRepository/hooks/post-receive
RUN chmod +x $JENKINS_HOME/WebContentRepository/hooks/post-receive


# --------------- PREPARE SSH DEAMON ---------------     
# prepare running sshd
RUN sed -i 's|session required pam_loginuid.so|session optional pam_loginuid.so|g' /etc/pam.d/sshd \
    && mkdir -p /var/run/sshd \
    && mkdir /root/.ssh
    
COPY ssh_config /etc/ssh/sshd_config


# -------------- CONFIGURE WEBSERVER --------------
# Allow the webserver to execute cgi scripts
#COPY serve-cgi-bin.conf /etc/apache2/conf-available/
#RUN a2enmod cgi

# Change the hosted directory to $JENKINS_HOME/WebContent
COPY 000-default.conf /etc/apache2/sites-available/

# -------------- START WEBSERVER AND SSH-DAEMON VIA SUPERVISOR --------------
COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf
CMD ["/usr/bin/supervisord"]